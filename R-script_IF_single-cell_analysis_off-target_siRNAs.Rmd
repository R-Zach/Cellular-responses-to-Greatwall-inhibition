---
title: "GLW inhibition (off-target kinases siRNA screen, RPE-1 and HeLa)"
output: html_document
date: "2023-11-23"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Loading Libraries
```{r message=FALSE, warning=FALSE, paged.print=FALSE}
library(dplyr)
library(tidyr)
library(ggplot2)
library(ggforce)
library(ggExtra)
library(grid)
library(gridExtra)
library(ggridges)
library(ggbeeswarm)
library(gghalves)
library(cowplot)
library(gplots)
library(lattice)
library(ggthemes)
library(scales)
library(tidyverse)
library(viridis)
library(ggnewscale)
library(ggh4x)
library(extrafont)
library(gtable)
```

## Establishing paths to data and results folders
```{r}
path_data <- ### Path to IF_single-cell_off-target_siRNAs.csv
path_results <- ### Path to an export folder
```

## Establoshing ggplot theme arguments
```{r}
graph_theme <- theme(
  plot.margin = margin(b = 0.2, l = 0.2, t = 0.2, r = 0.2, unit = "lines"),
  text = element_text(size = 1, family = "Arial"),
  panel.spacing.y = unit(0.1, "lines"),
  panel.spacing.x = unit(0.1, "lines"),
  panel.border = element_rect(colour = "#000000", fill = NA, linewidth = 0.5),
  panel.background = element_blank(),
  panel.grid.major.y = element_blank(),
  panel.grid.minor.y = element_blank(),
  panel.grid.major.x = element_blank(),
  panel.grid.minor.x = element_blank(),
  strip.background = element_blank(),
  strip.text.x = element_text(colour = "#000000", size = 6, margin = margin(b = 2, t = 2), vjust = 0, family = "Arial"),
  strip.text.y = element_text(colour = "#000000", size = 6, margin = margin(l = 2), family = "Arial"),
  strip.clip = "off",
  axis.ticks.x = element_line(colour = "#000000", linewidth = 0.35),
  axis.ticks.y = element_line(colour = "#000000", linewidth = 0.35),
  axis.ticks.length = unit(0.1, "lines"),
  axis.title.x = element_text(colour = "#000000", size = 6, margin = margin(t = 3), family = "Arial"),
  axis.title.y = element_text(colour = "#000000", size = 6, margin = margin(r = 2), family = "Arial"),
  axis.text.x = element_text(colour = "#000000", size = 6, margin = margin(t = 2), family = "Arial"),
  axis.text.y = element_text(colour = "#000000", size = 6, margin = margin(r = 2), family = "Arial"),
  plot.title = element_blank(),
  legend.key = element_rect(fill = "#FFFFFF"),
  legend.position = "none",
  legend.justification = "left",
  legend.key.width = unit(2, 'pt'),
  legend.key.height = unit(2, 'pt'),
  legend.text = element_text(colour = "#000000", size = 6, margin = margin(r = 1)),
  legend.margin = margin(r = 0, b = 0, l = 0, t = 0),
  legend.title = element_blank())
```

## Establishing colour pallette
```{r}
colour_pallette <- c("#D4D3CF", "#DC6B83", "#75B1CE", "#D8C367", "#526C94", "#000000")
```

## Establishing a function to normalise the raw IF data
```{r}
fun_normalise <- function (data, values, ref, bins = 100) {

  # Constructing the subset data-set containing the control data
  
  for (v in values) {
    
    if (v == "DAPI_total") {data.ref <- filter(data, condition %in% ref, EdU == "negative")}
    else {data.ref <- subset(data, condition %in% ref)}

    # log10-transformation of the data
    data.ref <- mutate(data.ref, value_log2 = log2(!!sym(v)))
    # Construction of the histogram
    histogram <- hist(x = data.ref$value_log2,
                      breaks = bins,
                      main = paste(unique(data$experiment), unique(data$cell_line), sep = " "),
                      xlab = paste("log2", v, sep = " "))
    
    # Selection of the histogram index (bin) with the highest number of observations
    index_max <- match(max(histogram$counts), histogram$counts)
    
    # Determination of the mid-log10-value of the bin with the highest number of observations
    value_max <- histogram$mids[index_max]
    
    # Determination of the normalisation factor (reversing the log10-transformation)
    normalisation_factor <- 2 ^ value_max
    
    # Normalisation of the original values
    data <- mutate(data, !!sym(paste(v, "norm", sep = "_")) := !!sym(v) / normalisation_factor)
    
    # Normalised DAPI intensities are multiplied by 2 so G1 populations center around 2 (2N) and G2 populations center around 4 (4N)
    if (v == "DAPI_total") {data <- mutate(data, !!sym(paste(v, "norm", sep = "_")) := 2 * !!sym(paste(v, "norm", sep = "_")))}
  }
  return(data)
}
```

## Establishing a function to establish density of points on a scatter plot
```{r}
get_density <- function(x, y, ...) {
  dens <- MASS::kde2d(x, y, ...)
  ix <- findInterval(x, dens$x)
  iy <- findInterval(y, dens$y)
  ii <- cbind(ix, iy)
  return(dens$z[ii])
}
```

## Creating a dataframe containing Hoechst, EdU and p21 intensity thresholds
```{r}
data_thresholds <- bind_rows(data.frame(feature = "Hoechst", T1 = 1.5, T2 = 3, T3 = 6),
                             data.frame(feature = "EdU", T1 = 1.5, T2 = NA, T3 = NA), 
                             data.frame(feature = "p21", T1 = 1.3, T2 = NA, T3 = NA))

data_thresholds
```

## Importing data
```{r}
data_raw = data.frame()

for (file in list.files(path_data, pattern = ".csv")) {
  
  tmp.data <- read.csv(paste(path_data, "/", file, sep = ""), sep = ",") %>%
    mutate(experiment = file) %>%
    separate(col = "Condition", into = c("siRNA", "treatment"), sep = "_", remove = FALSE) %>%
    dplyr::rename(cell_line = Cell_Line, condition = Condition, cyto_id = Cyto_ID)
  
  data_raw = bind_rows(data_raw, tmp.data)
  rm(tmp.data)
}

head(data_raw)
```

## Importing data
```{r}
data_raw <- read.csv(path_data, sep = ",")

head(data_raw)
```

## Normalising data
```{r}
data_normalised = data_raw2 %>%
  mutate(experiment = unlist(str_extract_all(data_raw2$experiment, "\\d+"))) %>%
  reframe(nuclei_count = n(),
          nuclei_area = sum(area_nucleus),
          DAPI_total = sum(integrated_int_DAPI),
          EdU_mean = mean(intensity_mean_EdU_nucleus) / mean(intensity_mean_EdU_cyto),
          p21_mean = mean(intensity_mean_p21_nucleus),
          .by = c(experiment, plate_id, well, well_id, image_id, cell_line, condition, treatment, siRNA, cyto_id, area_cell)) %>%
  
  group_by(experiment) %>%
  group_split() %>%
  lapply(fun_normalise, values = c("EdU_mean", "p21_mean"), ref = c("CTR_0")) %>%
  bind_rows() %>%
  mutate(EdU = case_when(EdU_mean_norm <= filter(data_thresholds, feature == "EdU")$T1 ~ "negative",
                         EdU_mean_norm > filter(data_thresholds, feature == "EdU")$T1 ~ "positive"),
         p21 = case_when(p21_mean_norm <= filter(data_thresholds, feature == "p21")$T1 ~ "negative",
                         p21_mean_norm > filter(data_thresholds, feature == "p21")$T1 ~ "positive")) %>%
  group_by(experiment, cell_line) %>%
  group_split() %>%
  lapply(fun_normalise, values = c("DAPI_total", "area_cell", "nuclei_area"), ref = c("CTR_0")) %>%
  bind_rows() %>%
  
  mutate(Hoechst = case_when(DAPI_total_norm <= filter(data_thresholds, feature == "Hoechst")$T1 ~ "Debris",
                             DAPI_total_norm <= filter(data_thresholds, feature == "Hoechst")$T2 ~ "2N",
                             DAPI_total_norm <= filter(data_thresholds, feature == "Hoechst")$T3 ~ "4N",
                             DAPI_total_norm > filter(data_thresholds, feature == "Hoechst")$T3 ~ "8N+")) %>%
  
  mutate(cell_cycle = case_when(Hoechst == "Debris" ~ "Debris",
                                Hoechst == "2N" & EdU == "negative" ~ "2N",
                                Hoechst == "4N" & EdU == "negative" ~ "4N",
                                Hoechst == "2N" & EdU == "positive" ~ "S",
                                Hoechst == "4N" & EdU == "positive" ~ "S",
                                Hoechst == "8N+" ~ "8N+",
                                .default = "Unassigned"))

head(data_normalised)
```

## Establishing cell counts
```{r}
data_cell_counts <- data_normalised %>%
  filter(cell_cycle != "Debris") %>%
  reframe(count = n(), .by = c(experiment, cell_line, siRNA, treatment)) %>%
  group_by(experiment, cell_line) %>%
  mutate(count_norm = count / max(count)) %>%
  ungroup()

data_cell_counts
```

## Establishing proportions of cell cycle groups
```{r}
data_cell_cycle_proportions <- data_normalised %>%
  filter(cell_cycle != "Debris") %>%
  reframe(count = n(), .by = c(experiment, cell_line, siRNA, treatment, cell_cycle)) %>%
  group_by(experiment, cell_line, siRNA, treatment) %>%
  mutate(prop = 100 * count / sum(count)) %>%
  ungroup()

data_p21_proportions <- data_normalised %>%
  filter(!(cell_cycle %in% c("Debris", "S"))) %>%
  reframe(count = n(), .by = c(experiment, cell_line, siRNA, treatment, p21)) %>%
  group_by(experiment, cell_line, siRNA, treatment) %>%
  mutate(prop = 100 * count / sum(count)) %>%
  ungroup()

head(data_cell_cycle_proportions)
head(data_p21_proportions)
```

## Establishing spatial densities of data points in EdU ~ Hoechst scatterplots
```{r}
data_normalised_subset_random <- data_normalised %>%
  group_by(experiment, cell_line, siRNA, treatment) %>%
  group_split() %>%
  lapply((function (data, n = 2000) {
    if (nrow(data) > n) {
      data <- sample_n(data, n)
      return(data)
    } else {
        return(data)
      }
  })) %>%
  bind_rows() %>%
  group_by(cell_line, condition) %>%
  mutate(density_DAPI_EdU = get_density(log2(DAPI_total_norm), log2(EdU_mean_norm), n = 150, h = c(0.5, 0.5)),
         density_DAPI_p21 = get_density(log2(DAPI_total_norm), log2(p21_mean_norm), n = 150, h = c(0.5, 0.5))) %>%
  ungroup()
  
```

## Plotting EdU ~ Hoechst scatterplots and marginal histograms of Hoechst intensities in HCC1395, U2OS, RPE-1, MM231, HeLa and BT-549 cells
```{r}
list_cell_lines <- "RPE-1"
# list_cell_lines <- "HeLa"

data_graph <- filter(data_normalised_subset_random,
                     cell_cycle %in% c("Debris", "2N", "S", "4N", "8N+"),
                     cell_line %in% list_cell_lines) %>%
  
  mutate(cell_cycle = factor(cell_cycle, levels = c("Debris", "2N", "S", "4N", "8N+")),
         siRNA = factor(siRNA,
                        levels = c("Lipofectamine", "CTR", "PPP2R2A", "MASTL", "NAUK1", "MAP3K9", "TAB2", "PKD2", "MELK", "GSK3B", "STK17A", "MAST1", "ULK2", "MARK3", "HIPK2", "CHEK1"),
                        labels = c("NT", "CTR", "PPP2R2A", "MASTL", "NAUK1", "MAP3K9", "TAB2", "PKD2", "MELK", "GSK3B", "STK17A", "MAST1", "ULK2", "MARK3", "HIPK2", "CHEK1")),
         treatment = factor(treatment, levels = c(0, 0.5)),
         drug = "MAST-L inhibitor C-604")

graph_marginal_Hoechst <- ggplot(data = filter(data_graph,
                                               cell_line %in% list_cell_lines),
                                 
                                 aes(x = DAPI_total_norm, y = treatment)) +
  
  stat_binline(linewidth = 0.25, bins = 50, colour = "#000000", fill = colour_pallette[5], alpha = 0.5) +
  scale_x_continuous(trans = "log2", limits = c(1.1, 35), breaks = c(2, 4, 8, 16, 32)) +
  scale_y_discrete(limits = rev) +
  labs(y = "C-604\n(µM)") +
  facet_nested(drug ~ cell_line + siRNA, nest_line = element_line(linetype = 1), strip = strip_nested(clip = "off"), resect = unit(0.04, "in"),) +
  graph_theme +
  theme(
    strip.text.x = element_text(colour = "#000000", size = 6, margin = margin(b = 2, t = 2)),
    strip.text.y = element_blank(),
    axis.text.y = element_text(colour = "#000000", size = 6, margin = margin(r = 2)),
    panel.spacing.y = unit(0.075, "lines"),
    panel.spacing.x = unit(0.075, "lines"),
    panel.border = element_blank(),
    plot.margin = margin(b = 0.1, l = 0.35, t = 0.1, r = 0.15, unit = "lines"),
    axis.title.y = element_text(colour = "#000000", size = 6, margin = margin(r = 0), hjust = 0.55),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    axis.text.x = element_blank())

data_graph <- mutate(data_graph, treatment = factor(treatment, levels = c(0, 0.5), labels = c("0 µM", "0.5 µM")))

graph_cell_cycle_scatter <- ggplot() +
  
  geom_vline(xintercept = filter(data_thresholds, feature == "Hoechst")$T1, linewidth = 0.25, linetype = "dashed", colour = "#000000") +
  geom_vline(xintercept = filter(data_thresholds, feature == "Hoechst")$T2, linewidth = 0.25, linetype = "dashed", colour = "#000000") +
  geom_vline(xintercept = filter(data_thresholds, feature == "Hoechst")$T3, linewidth = 0.25, linetype = "dashed", colour = "#000000") +
  geom_vline(xintercept = filter(data_thresholds, feature == "Hoechst")$T4, linewidth = 0.25, linetype = "dashed", colour = "#000000") +
  geom_hline(yintercept = filter(data_thresholds, feature == "EdU")$T1, linewidth = 0.25, linetype = "dashed", colour = "#000000") +
  
  geom_point(data = filter(data_graph, cell_line %in% list_cell_lines),
             aes(x = DAPI_total_norm, y = EdU_mean_norm, colour = cell_cycle, alpha = density_DAPI_EdU),
             size = 0.75, stroke = 0.1, shape = 16) +
  
  scale_colour_manual(values = c(colour_pallette[1], colour_pallette[2], colour_pallette[3], colour_pallette[4], colour_pallette[5], colour_pallette[6])) +
  
  scale_x_continuous(trans = "log2", limits = c(1.3, 35), breaks = c(2, 4, 8, 16, 32)) +
  scale_y_continuous(trans = "log2", limits = c(0.8, 24), breaks = c(1, 2, 4, 8, 16)) +
  labs(x = "Hoechst (normalised)", y = "EdU (normalised)") +
  scale_alpha_continuous(range = c(0.1, 1)) +
  facet_nested(drug + treatment ~ cell_line + siRNA, strip = strip_nested(clip = "off")) +
  graph_theme +
  theme(
    axis.text.x = element_text(colour = "#000000", size = 6, angle = -90, hjust = 0, vjust = 0.5, margin = margin(t = 2), family = "Arial"),
    axis.text.y = element_text(colour = "#000000", size = 6, margin = margin(r = 0), family = "Arial"),
    axis.title.x = element_text(colour = "#000000", size = 6, margin = margin(t = 2), family = "Arial"),
    axis.title.y = element_text(colour = "#000000", size = 6, margin = margin(r = 2), family = "Arial"),
    strip.text.y = element_text(colour = "#000000", size = 6, margin = margin(l = 2), vjust = 0, family = "Arial"),
    panel.spacing.y = unit(0.075, "lines"),
    panel.spacing.x = unit(0.075, "lines"),
    plot.margin = margin(b = 0.1, l = 0.1, t = -0.35, r = 0.1, unit = "lines"),
    strip.text.x = element_blank(),
    legend.position = "none",
    legend.justification = "center",
    legend.direction = "vertical",
    legend.key.width = unit(1, 'mm'),
    legend.key.height = unit(1, 'mm'),
    legend.text = element_text(colour = "#000000", size = 6),
    legend.margin = margin(b = 50, r = -7),
    legend.spacing.y = unit(1, "mm"),
    legend.title = element_blank()) +
  guides(alpha = FALSE,
         color = guide_legend(override.aes = list(size = 2),
                              nrow = 6,
                              label.position = "left"))

graph_cell_cycle <- plot_grid(graph_marginal_Hoechst,
                              graph_cell_cycle_scatter,
                              align = "v", axis = "lr",
                              rel_heights = c(1.25, 2),
                              rel_widths = c(1, 1),
                              nrow = 2, ncol = 1)

ggsave(paste(path_results, "graph_cell_cycle_scatterplot_", list_cell_lines,".pdf", sep = ""), graph_cell_cycle,
       width = 174, height = 42.5, units = "mm", device = cairo_pdf)
```

## Plotting proportions of 2N, S, 4N and 8N+ cell cycle groups
```{r}
list_cell_lines <- "RPE-1"
# list_cell_lines <- "HeLa"

list_siRNAs <- c("CTR", "MASTL", "NAUK1", "MAP3K9", "TAB2", "PKD2", "MELK", "GSK3B", "STK17A", "MAST1", "ULK2", "MARK3", "HIPK2", "CHEK1")

data_graph <- data_cell_cycle_proportions %>%
  mutate(treatment = as.numeric(treatment)) %>%
  filter(siRNA %in% list_siRNAs, cell_line %in% list_cell_lines, treatment %in% c(0, 0.5)) %>%
  mutate(cell_cycle = factor(cell_cycle, levels = c("2N", "S", "4N", "8N+")),
         siRNA = factor(
           siRNA, levels = list_siRNAs,
           labels = c("CTR", "GWL", "NAUK1", "MAP3K9", "TAB2", "PKD2", "MELK", "GSK3B", "STK17A", "MAST1", "ULK2", "MARK3", "HIPK2", "CHEK1"))) %>%
  arrange(treatment, experiment, cell_cycle) %>%
  group_by(cell_line, cell_cycle, siRNA) %>%
  mutate(x_axis = 1:n()) %>%
  ungroup()

data_stats <- data_graph %>%
  group_by(cell_line, siRNA, cell_cycle) %>%
  group_split() %>%
  lapply((function (data) {
    
    tmp.output <- data.frame()
    
    for (t in unique(data$treatment)[unique(data$treatment) != 0]) {

      tmp.data <- filter(data, treatment %in% c(0, t)) %>%
        dplyr::select(experiment, cell_line, treatment, siRNA, cell_cycle, prop) %>%
        spread(key = treatment, value = prop) %>%
        replace(is.na(.), 0)
      
      tmp.stats <- t.test(tmp.data[[6]], tmp.data[[5]],
                          alternative = "greater",
                          paired = FALSE,
                          var.equal = TRUE)
      
      tmp.results <- data.frame(cell_line = unique(tmp.data$cell_line),
                                siRNA = unique(tmp.data$siRNA),
                                cell_cycle = unique(tmp.data$cell_cycle),
                                treatment = t,
                                p = tmp.stats$p.value)
      
      tmp.output <- bind_rows(tmp.output, tmp.results)
    }
    return(tmp.output)
  })) %>%
  bind_rows() %>%
  mutate(significance = case_when(p < 0.001 ~ "***",
                                  p < 0.01 ~ "**",
                                  p < 0.05 ~ "*",
                                  .default = "ns")) %>%
  group_by(siRNA, cell_cycle) %>%
  arrange(treatment) %>%
  mutate(x_axis = ifelse(treatment == "0.5", 5, 8)) %>%
  mutate(siRNA = factor(siRNA, levels = c("CTR", "GWL", "NAUK1", "MAP3K9", "TAB2", "PKD2", "MELK", "GSK3B", "STK17A", "MAST1", "ULK2", "MARK3", "HIPK2", "CHEK1"))) %>%
  filter(cell_cycle %in% c("4N", "8N+")) %>%
  group_by(cell_line, treatment, siRNA) %>%
  group_split() %>%
  lapply((function (data) {
    if(sum(data$significance == "ns") == 2) {
      return(head(data, 1))
    } else {
      return(filter(data, significance != "ns"))
    }
  })) %>%
  bind_rows()

graph_cell_cycle_proportions <- ggplot() +
  
  geom_bar(data = data_graph,
           aes(x = x_axis,
               y = prop,
               fill = cell_cycle,
               group = interaction(siRNA, treatment, cell_cycle)),
           stat = "identity", position = "stack",
           width = 0.95) +
  
  geom_segment(data = filter(data_graph, treatment == 0, cell_cycle == "2N", experiment == 1), aes(x = 0.575, xend = 0.575, y = 0, yend = 100),
               colour = colour_pallette[6], linetype = "solid", linewidth = 0.25) +
  
  geom_segment(data = filter(data_graph, treatment == 0, cell_cycle == "2N", experiment == 1), aes(x = 3.5, xend = 3.5, y = 0, yend = 100),
               colour = colour_pallette[6], linetype = "solid", linewidth = 0.25) +
  
  geom_segment(data = filter(data_graph, treatment == 0, cell_cycle == "2N", experiment == 1), aes(x = 6.425, xend = 6.425, y = 0, yend = 100),
               colour = colour_pallette[6], linetype = "solid", linewidth = 0.25) +
  
  geom_hline(yintercept = c(0, 100), colour = colour_pallette[6], linetype = "solid", linewidth = 0.25) +
  
  geom_text(data = filter(data_stats, significance != "ns", cell_cycle == "4N"), 
            aes(x = x_axis, y = 111, label = significance), size = 2.5, colour = colour_pallette[4]) +
  
  geom_text(data = filter(data_stats, significance != "ns", cell_cycle == "8N+"), 
            aes(x = x_axis, y = 101, label = significance), size = 2.5, colour = colour_pallette[5]) +
  
  geom_text(data = filter(data_stats, significance == "ns"), 
            aes(x = x_axis, y = 114, label = significance), size = 2, colour = colour_pallette[1]) +
  
  facet_nested(. ~ cell_line + siRNA,
               nest_line = element_line(linetype = 1, linewidth = 0.25),
               resect = unit(0.04, "in"),
               strip = strip_nested(clip = "off"),
               scales = "free_x", space = "free_x") +
  
  labs(x = "GWL inhibitor C-604 (µM)", y = "%") +
  
  scale_fill_manual(values = c(colour_pallette[2], colour_pallette[3], colour_pallette[4], colour_pallette[5])) +
  scale_x_continuous(expand = c(0, 0), breaks = c(2, 5, 8), labels = c(0 ,0.5, 2)) +
  scale_y_continuous(expand = c(0, 0), limits = c(-1.5, 122), breaks = c(0, 25, 50, 75, 100)) +
  graph_theme +
  theme(plot.margin = margin(b = 0.1, l = 0.1, t = 0.1, r = 0.6, unit = "lines"),
        panel.border = element_blank(),
        legend.position = "none",
        legend.justification = "center",
        legend.key.width = unit(5, 'pt'),
        legend.key.height = unit(4.5, 'pt'),
        legend.text = element_text(colour = "#000000", size = 6, margin = margin()),
        legend.margin = margin(t = 3, l = - 10),
        legend.title = element_blank())
  
ggsave(paste(path_results, "graph_cell_cycle_proportions_", list_cell_lines,".pdf", sep = ""), graph_cell_cycle_proportions,
       width = 167.5, height = 25, units = "mm", device = cairo_pdf)
```
























